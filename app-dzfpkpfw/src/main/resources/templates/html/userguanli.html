<h2 class="c_right_title">用户管理</h2>
<div class="p_box">
	<el-button type="primary" @click="userAddBtn">添加用户</el-button>
	<el-button type="primary" icon="search" @click="searchForm">查询</el-button>
  	<el-form :model="userManage" :inline="true">
		<el-form-item label="条件：" :label-width="formLabelWidth">
	      <el-input   v-model="userManage.name"  placeholder="请选择姓名或账户"></el-input>
	   </el-form-item>
		<el-form-item label="性别：" :label-width="formLabelWidth">
	      <el-select v-model="userManage.sex" placeholder="请选择">
	      	<el-option v-for="item in sexOptionsCopy" :key="item.key" :label="item.label" :value="item.value"></el-option>
	      </el-select>
	   </el-form-item>
		<el-form-item label="是否有效：" :label-width="formLabelWidth">
			<el-select v-model="userManage.useful" placeholder="请选择">
				<el-option v-for="item in usefulOptionsCopy" :key="item.key" :label="item.label" :value="item.value"></el-option>
			</el-select>
		</el-form-item>
    </el-form>
	  
	<el-table ref="multipleTable" :data="userData" border tooltip-effect="dark" align="center">
		<!--<el-table-column align="center" type="selection" width="55">			
		</el-table-column>-->
		<el-table-column align="center" prop="userName" label="姓名"  >
		</el-table-column>
		<el-table-column align="center" prop="accountName" label="账户"  >
		</el-table-column>
		<el-table-column align="center" prop="passWord" label="密码" v-if="accountName=='superAdmin'" >
		</el-table-column>
		<el-table-column align="center" prop="sex" label="性别" >
		</el-table-column>
		<el-table-column align="center" prop="useful" label="是否有效" :formatter="keyFormat">
		</el-table-column>
		<el-table-column align="center" label="操作"  width="200" >
			<template scope="scope">
				<el-button type="text" size="small" v-if="scope.row.useful==1"
						   @click.native.prevent="disableUser(scope.row.id)">禁用</el-button>
				<el-button type="text" size="small" v-if="scope.row.useful==0"
						   @click.native.prevent="startUser(scope.row.id)">启用</el-button>
				<el-button type="text" size="small" @click.native.prevent="userEdit(scope.row)">编辑</el-button>
				<el-button class="redfont" type="text" size="small" @click.native.prevent="deleteRow(scope.row.id)">删除</el-button>
			</template>
		</el-table-column>
	</el-table>
	<div class="paginationTool">
		<el-pagination
	      @size-change="handleSizeChange"
	      @current-change="handleCurrentChange"
	      :current-page="currentPage"
	      :page-sizes="[10, 20, 30, 40]"
		  :page-size="userManage.pageSize"
	      layout="total, sizes, prev, pager, next, jumper"
	      :total="totalNum">
	   </el-pagination>			
	</div>
		
	<el-dialog title="添加用户" :visible.sync="userAdd" :before-close="resetForm">
	  <el-form :model="userAddFrom" :rules="rules" ref="userAddFrom">
	  	<el-row>
	  		<el-col :span="16" :offset="4">
	  			<el-form-item label="姓名：" :label-width="formLabelWidth" prop="userName">
			      <el-input v-model="userAddFrom.userName" auto-complete="off"></el-input>
			    </el-form-item>
	  		</el-col>
	  		<el-col :span="16" :offset="4">
	  			<el-form-item label="账户：" :label-width="formLabelWidth" prop="accountName">
			      <el-input v-model="userAddFrom.accountName" auto-complete="off"></el-input>
			    </el-form-item>
	  		</el-col>
			<el-col :span="16" :offset="4">
				<el-form-item label="密码：" :label-width="formLabelWidth" prop="passWord">
					<el-input v-model="userAddFrom.passWord"  auto-complete="off"></el-input>
				</el-form-item>
			</el-col>
	  		<el-col :span="16" :offset="4">
	  			<el-form-item label="性别：" :label-width="formLabelWidth" prop="sex">
			      <el-select style="width: 100%;" v-model="userAddFrom.sex" placeholder="请选择性别" >
			        <el-option v-for="item in sexOptions" :key="item.key" :label="item.label" :value="item.value"></el-option>
			      </el-select>
			    </el-form-item>
	  		</el-col>
	  	</el-row>
	  </el-form>
	  <div slot="footer" class="dialog-footer">
	     <el-button @click="resetForm">取 消</el-button>
	    <el-button type="primary" @click="saveUser('userAddFrom')">确 定</el-button>
	  </div>
    </el-dialog>
    
    <el-dialog title="编辑用户" :visible.sync="userEdit1" >
	  <el-form v-model="userEditForm"  ref="userEditForm">
	  	<el-row>
	  		<el-col :span="16" :offset="4" >
	  			<el-form-item label="姓名：" :label-width="formLabelWidth" prop="userName">
			      <el-input v-model="userEditForm.userName" auto-complete="off"></el-input>
			    </el-form-item>
	  		</el-col>
	  		<el-col :span="16" :offset="4">
	  			<el-form-item label="账户：" :label-width="formLabelWidth" prop="accountName">
			      <el-input v-model="userEditForm.accountName"   auto-complete="off"></el-input>
			    </el-form-item>
	  		</el-col>
			<el-col :span="16" :offset="4">
				<el-form-item label="密码：" :label-width="formLabelWidth" prop="passWord">
					<el-input v-model="userEditForm.passWord"  type="password"  auto-complete="off"></el-input>
				</el-form-item>
			</el-col>
	  		<el-col :span="16" :offset="4">
	  			<el-form-item label="性别：" :label-width="formLabelWidth" prop="sex">
			      <el-select style="width: 100%;" v-model="userEditForm.sex" placeholder="请选择性别">
			        <el-option v-for="item in sexOptions" :key="item.key" :label="item.label" :value="item.value"></el-option>
			      </el-select>
			    </el-form-item>
	  		</el-col>
	  	</el-row>
	  </el-form>
	  <div slot="footer" class="dialog-footer">
	    <el-button @click="userEdit1 = false">取 消</el-button>
	    <el-button type="primary" @click="commitEdit">确 定</el-button>
	  </div>
    </el-dialog>

</div>

<script>

var app = new Vue({
el: '#app',
data : {
	userData: [],
	userManage:{
	  name:'',
	  useful:'',
	  sex:'',
	  pageNo:1,
	  pageSize:10
	},
	totalNum:0,
	sexOptionsCopy: [{
		value: '',
		label: '全部'
	},{
		value: '男',
		label: '男'
	}, {
		value: '女',
		label: '女'
	}],
	sexOptions: [{
		value: '男',
		label: '男',
		key: '001'
	}, {
		value: '女',
		label: '女',
		key: '002'
	}],
	usefulOptionsCopy: [{
		value: '',
		label: '全部'
	},{
		value: '1',
		label: '是'
	}, {
		value: '0',
		label: '否'
	}],
	usefulOptions: [{
		value: '1',
		label: '是'
	}, {
		value: '0',
		label: '否'
	}],
	rules: {
		userName: [{
			required: true,
			message: '请输入名字',
			trigger: 'blur'
		}],
		accountName: [{
			required: true,
			message: '请输入账户',
			trigger: 'blur'
		}],
		passWord: [{
			required: true,
			message: '请输入密码',
			trigger: 'blur'
		}],
		sex: [{
			required: true,
			message: '请选择性别',
			trigger: 'blur'
		}]
	},
	formLabelWidth: '90px',
	userAdd:false,
	userEdit1:false,
	userAddFrom:{//添加用户
		userName:'',
		accountName:'',
		passWord:"",
		sex:''
	},
	userEditForm:{//编辑用户
		id:'',
		userName:'',
		accountName:'',
		passWord:"",
		sex:''
	},
	rowDate:null,
	currentPage:1,
    accountName:''
	},
	created:function () {
		this.accountName = sessionStorage.getItem('accountName');
		this.searchForm();
	},
	methods: {
		keyFormat(row, column){
			var key=row[column.property];
			if (key == undefined) {
				return "";
			}else if(key==0){
				return "无效";
			}else if(key==1){
				return "有效";
			}else {
				return "未知";
			}
		},
		svnTableData(){
			var that = this;
			$.ajax({
				type:"get",
				url:"/rest/user/plist",
				async:true,
				dataType:"json",
				success:function(res){
					console.info(res)
					that.userData = res.data.list;
				}

			});
		},
		//添加用户保存
		saveUser(formName){
            var that = this;
            that.$refs[formName].validate((valid) => {
                if (valid) {
                    console.info(that.userAddFrom)
                    $.ajax({
                        type:"put",
                        url:"/rest/user/add",
                        async:true,
						data:that.userAddFrom,
                        dataType:"json",
                        success:function(res){
                            if(res.success){
                                that.searchForm();
                                that.$message({
                                    type: 'success',
                                    message: '新增成功!'
                                });
                                that.resetForm();
                            }else{
                                that.$message({
                                    type: 'error',
                                    message: res.errorMsg
                                });
                            }
                        }
                    });

                } else {
            		return false;
		        }
		  	});
		},

		//行编辑
		userEdit(row){
			var that = this;
			var id = row.id;
			$.ajax({
				type:"get",
				url:"/rest/user/"+id,
				async:true,
				dataType:"json",
				success:function(res){
					console.info(res)
					that.userEditForm = res.data;
					that.userEdit1 = true;
				}
			});
		},
		//提交修改
		commitEdit(){
			var that = this;
            that.userEditForm.createTime = new Date();
			$.post("/rest/user/update",that.userEditForm,function(result){
				if(result.success){
					that.searchForm();
                    that.$message({
						type: 'success',
						message: '修改成功!'
					});
                    that.userEdit1 = false;
				}else{
                    that.$message({
						type: 'error',
						message: '修改失败!'
					});
				}
			});
		},
		//删除行
		deleteRow(id) {
		    var that = this;
            that.$confirm('是否确定删除该用户?', '提示', {
			  confirmButtonText: '确定',
			  cancelButtonText: '取消',
			  type: 'warning'
			}).then(() => {
                $.ajax({
                type:"delete",
                url:"/rest/user/delete/"+id,
                async:true,
                dataType:"json",
                success:function(res){
                    if(res.success){
                        that.$message({
                            type: 'success',
                            message: '删除成功!'
                        });
                        that.searchForm();
					}else{
                        that.$message({
                            type: 'error',
                            message: '删除失败!'
                        });
					}
                }
				});
			}).catch(() => {
			});
	   },
	   //搜索
		searchForm(){
			const that = this;
			$.get("/rest/user/plist",that.userManage,function(result){
				if(result.success){
				    console.info(result)
                    that.userData = result.data.list;
                    that.totalNum = result.data.total;
				}
			});
		},
        disableUser(id){
            const that = this;
            $.post("/rest/user/disable/"+id,{},function(res){
                if(res.success){
                    that.$message({
                        type: 'success',
                        message: '禁用成功!'
                    });
                    that.searchForm();
                }else{
                    that.$message({
                        type: 'error',
                        message: '禁用失败!'
                    });
                }
            });
        },
        startUser(id){
            const that = this;
            $.post("/rest/user/start/"+id,{},function(res){
                if(res.success){
                    that.$message({
                        type: 'success',
                        message: '启用成功!'
                    });
                    that.searchForm();
                }else{
                    that.$message({
                        type: 'error',
                        message: '启用失败!'
                    });
                }
            });
        },
		//添加用户
		userAddBtn(){
			this.userAdd = true;
		},
		//重置
		resetForm() {
            this.userAddFrom.userName='';
            this.userAddFrom.accountName='';
            this.userAddFrom.sex='';
			this.userAddFrom.passWord='';
			this.userAdd = false;
		},
		handleSizeChange(val) {
			this.userManage.pageSize = val;
            this.searchForm();
			console.log(`每页 ${val} 条`);
		},
		handleCurrentChange(val) {
			this.userManage.pageNo = val;
            this.searchForm();
			console.log(`当前页: ${val}`);
		}
	},

});

</script>